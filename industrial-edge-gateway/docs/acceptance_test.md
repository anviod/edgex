# 边缘计算引擎分钟级执行结果存储（bblot）验收用例文档

## 1. 验收目标

验证系统具备：

* 规则执行结果的**分钟级持久化能力**；
* 数据准确性、一致性、可追溯性；
* 对原有实时执行链路**无性能影响、无阻塞风险**。

---

## 2. 验收环境

| 项目   | 要求                          |
| ---- | --------------------------- |
| OS   | Windows 10/11 or Linux      |
| CPU  | 2 Core+                     |
| RAM  | 4GB+                        |
| Disk | SSD (推荐)                   |
| 依赖   | bbolt (嵌入式数据库)             |

---

## 3. 验收用例

### 3.1 基础功能验证

| 用例编号 | 用例名称 | 前置条件 | 操作步骤 | 预期结果 |
| :--- | :--- | :--- | :--- | :--- |
| **AC-01** | **正常触发写入** | 规则引擎运行中，bblot 正常 | 1. 配置一条阈值规则 (t1 > 10)<br>2. 发送数据 t1=11 触发规则<br>3. 等待 1 分钟 | 1. 规则状态变为 ALARM<br>2. 查看 bblot 数据库 `bblot` bucket<br>3. 存在 key 为 `{ruleID}_{yyyy-MM-dd HH:mm}` 的记录<br>4. 记录内容包含正确状态、触发时间 |
| **AC-02** | **状态恢复写入** | 规则处于 ALARM 状态 | 1. 发送数据 t1=5 (恢复正常)<br>2. 等待 1 分钟 | 1. 规则状态变为 NORMAL<br>2. bblot 新增一条分钟记录<br>3. 记录状态为 NORMAL |
| **AC-03** | **分钟级去重** | 规则引擎运行中 | 1. 在 1 分钟内连续触发 10 次规则 | 1. 规则执行动作 10 次 (或根据去抖配置)<br>2. bblot 该分钟内**只有一条记录** (最后一次状态更新) |

### 3.2 异常处理验证

| 用例编号 | 用例名称 | 前置条件 | 操作步骤 | 预期结果 |
| :--- | :--- | :--- | :--- | :--- |
| **AC-04** | **存储故障** | 模拟 bbolt 写入失败 (如只读权限) | 1. 触发规则 | 1. 规则正常执行，动作正常触发<br>2. 控制台/日志输出 "Failed to save bblot snapshot"<br>3. **系统不崩溃，不阻塞后续规则** |
| **AC-05** | **规则错误记录** | 规则配置错误 | 1. 配置错误表达式 (如 `t1 > `)<br>2. 触发规则 | 1. 规则执行报错<br>2. bblot 记录包含 `error_message` 字段 |

### 3.3 性能与稳定性验证

| 用例编号 | 用例名称 | 前置条件 | 操作步骤 | 预期结果 |
| :--- | :--- | :--- | :--- | :--- |
| **AC-06** | **重启连续性** | 系统运行并有 bblot 记录 | 1. 停止系统<br>2. 重启系统<br>3. 触发规则 | 1. 新的 bblot 记录正常写入<br>2. 旧的历史记录不丢失<br>3. `trigger_count` 在原有基础上累加 (如果状态恢复逻辑支持) |
| **AC-07** | **并发写入压力** | 100 条规则 | 1. 同时触发 100 条规则 | 1. 所有规则正常执行<br>2. bblot 中有 100 条对应的分钟记录<br>3. 无死锁，无 panic |

---

## 4. 验收结论

* [ ] 通过
* [ ] 不通过
* [ ] 有条件通过 (需修复非关键缺陷)

**签字**: ____________________  **日期**: _______________
